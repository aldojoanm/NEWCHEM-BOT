<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Inbox New Chem</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--card:#0b1220;--muted:#9ca3af;--txt:#e5e7eb;--accent:#22c55e;}
    *{box-sizing:border-box} body{margin:0;background:#0a0f1e;color:var(--txt);font:14px system-ui,Segoe UI,Roboto,Ubuntu,Arial}
    .app{display:grid;grid-template-columns:320px 1fr;height:100vh}
    .left{border-right:1px solid #1f2937;background:var(--panel);display:flex;flex-direction:column}
    .right{display:flex;flex-direction:column}
    .top{padding:12px;border-bottom:1px solid #1f2937;display:flex;gap:8px;align-items:center}
    .top input{flex:1;background:#0b1220;border:1px solid #1f2937;color:var(--txt);padding:10px 12px;border-radius:10px}
    .btn{background:#0b1220;border:1px solid #1f2937;color:var(--txt);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#374151}
    .list{overflow:auto}
    .item{padding:12px 14px;border-bottom:1px solid #1f2937;cursor:pointer;display:flex;gap:10px;align-items:center}
    .item:hover{background:#0b1220}
    .item.active{background:#0b1220;border-left:3px solid var(--accent)}
    .name{font-weight:600}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pill{margin-left:auto;background:#1f2937;color:#cbd5e1;font-size:12px;border-radius:999px;padding:2px 8px}
    .pill.human{background:#7c3aed}
    .chat{flex:1;display:flex;flex-direction:column;background:#0b1220}
    .msgs{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:70%;padding:10px 12px;border-radius:14px;line-height:1.3;white-space:pre-wrap}
    .u{background:#1f2937;align-self:flex-start;border-bottom-left-radius:4px}
    .b{background:#111827;align-self:flex-end;border-bottom-right-radius:4px}
    .a{background:#064e3b;align-self:flex-end;border-bottom-right-radius:4px}
    .sys{background:#0b1220;border:1px dashed #334155;color:#93c5fd;align-self:center}
    .input{display:flex;gap:8px;padding:12px;border-top:1px solid #1f2937;background:#0a0f1e}
    .input textarea{flex:1;background:#0b1220;border:1px solid #1f2937;color:var(--txt);padding:10px 12px;border-radius:10px;min-height:44px;max-height:140px}
    .row{display:flex;gap:8px}
    .sm{padding:8px 10px}
    @media (max-width:900px){ .app{grid-template-columns:1fr} .left{display:none} .app.show-left .left{display:flex} .app.show-left .right{display:none} }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="left">
    <div class="top">
      <input id="search" placeholder="Buscar...">
      <button class="btn sm" id="refresh">⟳</button>
      <button class="btn sm" id="logout">Salir</button>
    </div>
    <div class="list" id="list"></div>
  </div>
  <div class="right">
    <div class="top">
      <button class="btn sm" id="toggleLeft">☰</button>
      <div id="title" style="font-weight:700">Inbox</div>
      <span id="status" class="pill" style="margin-left:auto;display:none"></span>
      <div class="row">
        <button class="btn sm" id="takeHuman">⏸️ Pausar bot</button>
        <button class="btn sm" id="resumeBot">▶️ Bot ON</button>
        <button class="btn sm" id="markRead">✓ Leído</button>
      </div>
    </div>
    <div class="chat">
      <div class="msgs" id="msgs"></div>
      <div class="input">
        <textarea id="box" placeholder="Escribe como asesor..."></textarea>
        <button class="btn" id="send">Enviar</button>
      </div>
    </div>
  </div>
</div>

<script>
const api = {
  token: localStorage.getItem('AGENT_TOKEN') || '',
  base: '',
  headers(){ return { 'Authorization':'Bearer '+this.token, 'Content-Type':'application/json' }; },
  async convos(){ const r=await fetch('/wa/agent/convos',{headers:this.headers()}); if(!r.ok) throw 0; return r.json(); },
  async history(id){ const r=await fetch('/wa/agent/history/'+encodeURIComponent(id),{headers:this.headers()}); if(!r.ok) throw 0; return r.json(); },
  async send(to,text){ const r=await fetch('/wa/agent/send',{method:'POST',headers:this.headers(),body:JSON.stringify({to,text})}); if(!r.ok) throw 0; return r.json(); },
  async read(to){ const r=await fetch('/wa/agent/read',{method:'POST',headers:this.headers(),body:JSON.stringify({to})}); if(!r.ok) throw 0; return r.json(); },
  async handoff(to,mode){ const r=await fetch('/wa/agent/handoff',{method:'POST',headers:this.headers(),body:JSON.stringify({to,mode})}); if(!r.ok) throw 0; return r.json(); }
};

(async function bootstrap(){
  if(!api.token){
    const t = prompt('Token de agente');
    if(!t) return;
    localStorage.setItem('AGENT_TOKEN', t);
    api.token = t;
  }

  const elList = document.getElementById('list');
  const elMsgs = document.getElementById('msgs');
  const elTitle= document.getElementById('title');
  const elStatus= document.getElementById('status');
  const box = document.getElementById('box');
  let current = null;
  let allConvos = [];

  function fmt(ts){ if(!ts) return ''; const d=new Date(ts); return d.toLocaleString(); }
  function renderList(filter=''){
    elList.innerHTML='';
    const q = (filter||'').toLowerCase();
    for(const c of allConvos){
      if(q && !String(c.name).toLowerCase().includes(q) && !String(c.id).includes(q)) continue;
      const div = document.createElement('div');
      div.className = 'item'+(current && current.id===c.id?' active':'');
      div.onclick = async ()=>{ await openChat(c.id); };
      div.innerHTML = `
        <div>
          <div class="name">${c.name||c.id}</div>
          <div class="sub">${(c.last||'').replace(/\n/g,' · ').slice(0,80)}</div>
        </div>
        ${c.human?'<span class="pill human">HUMANO</span>':''}
        ${c.unread?`<span class="pill">${c.unread}</span>`:''}
      `;
      elList.appendChild(div);
    }
  }
  async function refresh(){
    try{
      const {convos} = await api.convos();
      allConvos = convos||[];
      renderList(document.getElementById('search').value);
    }catch(e){ /* noop */ }
  }
  function renderMsgs(mem){
    elMsgs.innerHTML = '';
    for(const m of mem){
      const div = document.createElement('div');
      let cls='sys';
      if(m.role==='user') cls='u';
      else if(m.role==='bot') cls='b';
      else if(m.role==='agent') cls='a';
      div.className = 'bubble '+cls;
      div.textContent = m.content;
      elMsgs.appendChild(div);
    }
    elMsgs.scrollTop = elMsgs.scrollHeight;
  }
  async function openChat(id){
    try{
      current = await api.history(id);
      elTitle.textContent = `${current.name||current.id} (${current.id})`;
      elStatus.style.display = current.human ? 'inline-block' : 'none';
      elStatus.textContent = current.human ? 'HUMANO' : '';
      renderMsgs(current.memory||[]);
      await api.read(current.id);      // marcar leído al abrir
      await refresh();                 // refrescar contadores
      if (window.innerWidth<900) document.getElementById('app').classList.remove('show-left');
    }catch(e){}
  }

  // Acciones
  document.getElementById('send').onclick = async ()=>{
    const txt = box.value.trim(); if(!txt || !current) return;
    box.value=''; await api.send(current.id, txt);
  };
  document.getElementById('markRead').onclick = async ()=>{ if(!current) return; await api.read(current.id); await refresh(); };
  document.getElementById('takeHuman').onclick = async ()=>{ if(!current) return; await api.handoff(current.id,'human'); elStatus.style.display='inline-block'; elStatus.textContent='HUMANO'; };
  document.getElementById('resumeBot').onclick = async ()=>{ if(!current) return; await api.handoff(current.id,'bot'); elStatus.style.display='none'; };

  // UI menores
  document.getElementById('refresh').onclick = refresh;
  document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('AGENT_TOKEN'); location.reload(); };
  document.getElementById('search').oninput = (e)=> renderList(e.target.value);
  document.getElementById('toggleLeft').onclick = ()=> document.getElementById('app').classList.toggle('show-left');

  // SSE
  try{
    const sse = new EventSource('/wa/agent/stream?token='+encodeURIComponent(api.token));
    sse.addEventListener('msg', (ev)=>{
      const data = JSON.parse(ev.data||'{}');
      if(current && data.id===current.id){
        current.memory = (current.memory||[]).concat([{role:data.role, content:data.content, ts:data.ts}]);
        renderMsgs(current.memory);
      }
      // cada mensaje puede cambiar contadores/orden
      refresh();
    });
  }catch(e){}

  // Primer carga
  await refresh();
})();
</script>
</body>
</html>
