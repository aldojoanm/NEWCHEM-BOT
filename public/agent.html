<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Inbox · New Chem</title>
<style>
:root{
  --bg:#0b141a;        /* fondo tipo WhatsApp */
  --side:#111b21;      /* sidebar */
  --chat:#0b141a;      /* chat area */
  --bubble-me:#075e54; /* verde envío */
  --bubble-me-2:#0b806f;
  --bubble-other:#202c33;
  --text:#e9edef;
  --muted:#8696a0;
  --accent:#22c55e;
  --ring:#233138;
  --radius:18px;
  --shadow:0 8px 24px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,Arial}

.app{display:grid;grid-template-columns: 360px 1fr; height:100dvh; overflow:hidden}

/* LEFT (chat list) */
.left{display:flex;flex-direction:column;background:var(--side);border-right:1px solid #1f2c33;min-width:280px}
.left .top{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid #1f2c33}
.brand{font-weight:700}
.input{
  background:#1f2c33;border:1px solid #26343b;color:var(--text);
  border-radius:999px;padding:10px 12px;flex:1;outline:none
}
.btn{background:#1f2c33;border:1px solid #26343b;color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
.btn:hover{filter:brightness(1.05)}
.list{overflow:auto}
.item{
  display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px 14px;border-bottom:1px solid #1f2c33;cursor:pointer
}
.item:hover{background:#182229}
.item.active{background:#182229}
.name{font-weight:600}
.sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta{display:flex;gap:6px;align-items:center}
.pill{font-size:11px;background:#233138;color:#cdd6da;border-radius:999px;padding:2px 8px}
.pill.human{background:#5b21b6}

/* RIGHT (chat) */
.right{display:flex;flex-direction:column;min-width:0;background:var(--chat)}
.header{
  display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #1f2c33;background:#111b21;position:sticky;top:0;z-index:3
}
.title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.actions{display:flex;gap:8px;margin-left:auto}
.btn.ghost{opacity:.85}
.btn.pri{background:linear-gradient(180deg,#0bb197,#0a8e7b);border-color:#0a8e7b}

.chat{flex:1;display:flex;flex-direction:column;background:var(--chat)}
.msgs{flex:1;overflow:auto;padding:16px 8vw 20px 8vw;display:flex;flex-direction:column;gap:6px}
@media (max-width:1100px){ .msgs{padding:12px 24px 20px} }

.date{align-self:center;font-size:12px;color:#d1d7db;background:#1f2c33;border:1px solid #27363d;border-radius:999px;padding:3px 10px;margin:10px 0}
.row{display:flex;gap:6px;max-width:80%}
.row.me{align-self:flex-end}
.row.other{align-self:flex-start}
.bubble{
  padding:9px 12px;border-radius:var(--radius);position:relative;box-shadow:var(--shadow);
  white-space:pre-wrap;word-break:break-word
}
.row.other .bubble{background:var(--bubble-other);border-top-left-radius:6px}
.row.me .bubble{background:linear-gradient(180deg,var(--bubble-me),var(--bubble-me-2));border-top-right-radius:6px}
.badge{display:inline-block;font-size:11px;margin-left:6px;background:#2a3840;color:#cde7ff;border:1px solid #35505b;border-radius:999px;padding:0 6px}
.badge.green{background:#1a4d43;border-color:#1a6a5b;color:#c7f7e3}

.time{font-size:11px;color:#cbd3d6;margin-top:3px;display:flex;gap:6px;align-items:center}
.check{font-size:12px;opacity:.9}

/* composer */
.composer{
  display:flex;gap:8px;align-items:flex-end;padding:10px;border-top:1px solid #1f2c33;background:#111b21
}
textarea{
  flex:1;background:#1f2c33;border:1px solid #26343b;color:var(--text);
  border-radius:12px;padding:10px 12px;min-height:46px;max-height:160px;resize:vertical;outline:none
}
.send{background:#00a884;border:0;color:#062a23;font-weight:700;border-radius:12px;padding:11px 16px;cursor:pointer}
.send:hover{filter:brightness(1.05)}

/* MOBILE */
@media (max-width:980px){
  .app{grid-template-columns:1fr}
  .left{position:fixed;inset:0 30% 0 0;transform:translateX(-100%);transition:.2s;z-index:5}
  .app.show-left .left{transform:none}
  .overlay{display:none}
  .app.show-left .overlay{display:block;position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(1px);z-index:4}
}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="overlay" id="overlay"></div>

  <aside class="left">
    <div class="top">
      <div class="brand">Inbox</div>
      <input class="input" id="search" placeholder="Buscar chat…">
      <button class="btn ghost" id="refresh" title="Refrescar">⟳</button>
      <button class="btn" id="logout" title="Salir">Salir</button>
    </div>
    <div class="list" id="list"></div>
  </aside>

  <main class="right">
    <div class="header">
      <button class="btn ghost" id="toggleLeft" title="Chats">☰</button>
      <div class="title" id="title">Selecciona un chat</div>
      <span id="status" class="pill" style="display:none"></span>
      <div class="actions">
        <button class="btn ghost" id="takeHuman">⏸️ Pausar</button>
        <button class="btn ghost" id="resumeBot">▶️ Bot ON</button>
        <button class="btn ghost" id="markRead">✓ Leído</button>
      </div>
    </div>

    <section class="chat">
      <div class="msgs" id="msgs"></div>
      <div class="composer">
        <textarea id="box" placeholder="Escribe como asesor… (Enter envía, Shift+Enter salto)"></textarea>
        <button class="send" id="send">Enviar</button>
      </div>
    </section>
  </main>
</div>

<script>
const api = {
  token: localStorage.getItem('AGENT_TOKEN') || '',
  headers(){ return { 'Authorization':'Bearer '+this.token, 'Content-Type':'application/json' }; },
  async convos(){ const r=await fetch('/wa/agent/convos',{headers:this.headers()}); if(!r.ok) throw 0; return r.json(); },
  async history(id){ const r=await fetch('/wa/agent/history/'+encodeURIComponent(id),{headers:this.headers()}); if(!r.ok) throw 0; return r.json(); },
  async send(to,text){ const r=await fetch('/wa/agent/send',{method:'POST',headers:this.headers(),body:JSON.stringify({to,text})}); if(!r.ok) throw 0; return r.json(); },
  async read(to){ const r=await fetch('/wa/agent/read',{method:'POST',headers:this.headers(),body:JSON.stringify({to})}); if(!r.ok) throw 0; return r.json(); },
  async handoff(to,mode){ const r=await fetch('/wa/agent/handoff',{method:'POST',headers:this.headers(),body:JSON.stringify({to,mode})}); if(!r.ok) throw 0; return r.json(); }
};

(function(){
  if(!api.token){
    const t = prompt('Token de agente');
    if(!t) return;
    localStorage.setItem('AGENT_TOKEN', t);
    api.token = t;
  }

  const app = document.getElementById('app');
  const overlay = document.getElementById('overlay');
  const elList = document.getElementById('list');
  const elMsgs = document.getElementById('msgs');
  const elTitle= document.getElementById('title');
  const elStatus= document.getElementById('status');
  const box    = document.getElementById('box');
  let current = null;
  let allConvos = [];

  function esc(s=''){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }
  const fmtTime = ts => new Date(ts||Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const fmtDate = ts => new Date(ts||Date.now()).toLocaleDateString();

  function renderList(filter=''){
    elList.innerHTML='';
    const q = (filter||'').toLowerCase();
    for(const c of allConvos){
      if(q && !String(c.name||'').toLowerCase().includes(q) && !String(c.id).includes(q)) continue;
      const row = document.createElement('div');
      row.className = 'item'+(current && current.id===c.id?' active':'');
      row.onclick = ()=> openChat(c.id);
      const last = (c.last||'').replace(/\n/g,' · ');
      row.innerHTML = `
        <div>
          <div class="name">${esc(c.name||c.id)}</div>
          <div class="sub">${esc(last).slice(0,90)}</div>
        </div>
        <div class="meta">
          ${c.human?'<span class="pill human">HUMANO</span>':''}
          ${c.unread?`<span class="pill">${c.unread}</span>`:''}
        </div>`;
      elList.appendChild(row);
    }
  }

  function parseBadgesText(text){
    const badges=[];
    text = text.replace(/\s*〔Botones〕/ig, ()=>{ badges.push({label:'Botones'}); return '' });
    text = text.replace(/\s*〔Lista:\s*([^\〕]+)\〕/ig, (_,t)=>{ badges.push({label:'Lista: '+t}); return '' });
    if(/^✅\s+/.test(text)) badges.push({label:'Selección', kind:'green'});
    return {text:text.trim(), badges};
  }

  function renderMsgs(mem){
    elMsgs.innerHTML='';
    let lastDate='';
    (mem||[]).forEach(m=>{
      const d = fmtDate(m.ts);
      if(d!==lastDate){
        const sep=document.createElement('div');
        sep.className='date';
        sep.textContent=d;
        elMsgs.appendChild(sep);
        lastDate=d;
      }
      const side = m.role==='agent' ? 'me' : 'other';
      const row = document.createElement('div');
      row.className = 'row '+side;
      const bubble = document.createElement('div');
      bubble.className='bubble';
      const parsed = parseBadgesText(m.content||'');
      bubble.innerHTML = esc(parsed.text) + (parsed.badges.length?' '+parsed.badges.map(b=>`<span class="badge ${b.kind||''}">${esc(b.label)}</span>`).join(''):'');
      row.appendChild(bubble);

      const meta=document.createElement('div');
      meta.className='time';
      meta.innerHTML = esc(fmtTime(m.ts)) + (side==='me' ? ' <span class="check">✓✓</span>' : '');
      row.appendChild(meta);

      elMsgs.appendChild(row);
    });
    elMsgs.scrollTop = elMsgs.scrollHeight;
  }

  async function refresh(){
    try{
      const {convos} = await api.convos();
      allConvos = convos||[];
      renderList(document.getElementById('search').value);
      if(!current && allConvos.length) openChat(allConvos[0].id);
    }catch(e){}
  }

  async function openChat(id){
    try{
      current = await api.history(id);
      elTitle.textContent = `${current.name||current.id} · ${current.id}`;
      elStatus.style.display = current.human ? 'inline-block' : 'none';
      elStatus.className='pill '+(current.human?'human':'');
      elStatus.textContent = current.human ? 'HUMANO' : '';
      renderMsgs(current.memory||[]);
      await api.read(current.id);
      await refresh();
      if(window.innerWidth<980) app.classList.remove('show-left');
      sessionStorage.setItem('history:'+id, JSON.stringify(current.memory||[])); // cache local
    }catch(e){
      const cache = sessionStorage.getItem('history:'+id);
      if(cache) renderMsgs(JSON.parse(cache));
    }
  }

  // send
  document.getElementById('send').onclick = async ()=>{
    const txt = box.value.trim(); if(!txt || !current) return;
    const optimistic = {role:'agent', content:txt, ts:Date.now()};
    current.memory = (current.memory||[]).concat([optimistic]);
    renderMsgs(current.memory);
    sessionStorage.setItem('history:'+current.id, JSON.stringify(current.memory));
    box.value='';
    try{ await api.send(current.id, txt); }catch(e){}
  };
  box.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('send').click(); } });

  // actions
  document.getElementById('markRead').onclick = async ()=>{ if(!current) return; await api.read(current.id); await refresh(); };
  document.getElementById('takeHuman').onclick = async ()=>{ if(!current) return; await api.handoff(current.id,'human'); elStatus.style.display='inline-block'; elStatus.className='pill human'; elStatus.textContent='HUMANO'; };
  document.getElementById('resumeBot').onclick = async ()=>{ if(!current) return; await api.handoff(current.id,'bot'); elStatus.style.display='none'; };

  // left pane & search
  document.getElementById('refresh').onclick = refresh;
  document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('AGENT_TOKEN'); location.reload(); };
  document.getElementById('search').oninput = (e)=> renderList(e.target.value);
  document.getElementById('toggleLeft').onclick = ()=> app.classList.toggle('show-left');
  overlay.onclick = ()=> app.classList.remove('show-left');

  // SSE live updates
  try{
    const sse = new EventSource('/wa/agent/stream?token='+encodeURIComponent(api.token));
    sse.addEventListener('msg', (ev)=>{
      const data = JSON.parse(ev.data||'{}');
      if(current && data.id===current.id){
        current.memory = (current.memory||[]).concat([{role:data.role, content:data.content, ts:data.ts}]);
        renderMsgs(current.memory);
        sessionStorage.setItem('history:'+current.id, JSON.stringify(current.memory));
      }
      refresh();
    });
  }catch(e){}

  refresh();
})();
</script>
</body>
</html>
