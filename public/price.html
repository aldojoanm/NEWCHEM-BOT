<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lista de precios — New Chem</title>
<style>
  :root{ --bg:#0b141a; --panel:#111b21; --ring:#233138; --txt:#e9edef; --muted:#9bb0ba; --accent:#00a884; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 system-ui,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .card{background:#101a21;border:1px solid var(--ring);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--ring)}
  .title{font-weight:800}
  .muted{color:var(--muted);font-size:12px}
  .section{margin:0 14px 18px;border:1px solid var(--ring);border-radius:10px;overflow:auto;max-height:60vh}
  .section-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--ring);background:#0f1820;border-top-left-radius:10px;border-top-right-radius:10px}
  .section-title{font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--ring);padding:10px 12px;text-align:left;vertical-align:middle}
  th{background:#0f1820;position:sticky;top:0}
  tbody tr:hover{background:#0f1f27}
  .right{text-align:right}
  .center{text-align:center}
  .empty{color:var(--muted);font-style:italic}
  .pill{background:#0f1820;border:1px solid var(--ring);padding:6px 10px;border-radius:999px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div class="title">Lista de precios</div>
      <div class="muted"><span id="price-meta">Cargando…</span></div>
    </div>

    <!-- HERBICIDAS -->
    <div class="section">
      <div class="section-head">
        <div class="section-title">Herbicidas</div>
        <div class="pill">USD y Bs calculados con TC</div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:32%">Producto</th>
            <th style="width:18%">Presentación</th>
            <th style="width:12%">Unidad</th>
            <th class="right" style="width:19%">Precio (USD)</th>
            <th class="right" style="width:19%">Precio (Bs)</th>
          </tr>
        </thead>
        <tbody id="tbody-herb"></tbody>
      </table>
    </div>

    <!-- INSECTICIDAS -->
    <div class="section">
      <div class="section-head">
        <div class="section-title">Insecticidas</div>
        <div class="pill">USD y Bs calculados con TC</div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:32%">Producto</th>
            <th style="width:18%">Presentación</th>
            <th style="width:12%">Unidad</th>
            <th class="right" style="width:19%">Precio (USD)</th>
            <th class="right" style="width:19%">Precio (Bs)</th>
          </tr>
        </thead>
        <tbody id="tbody-insec"></tbody>
      </table>
    </div>

    <!-- FUNGICIDAS -->
    <div class="section">
      <div class="section-head">
        <div class="section-title">Fungicidas</div>
        <div class="pill">USD y Bs calculados con TC</div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:32%">Producto</th>
            <th style="width:18%">Presentación</th>
            <th style="width:12%">Unidad</th>
            <th class="right" style="width:19%">Precio (USD)</th>
            <th class="right" style="width:19%">Precio (Bs)</th>
          </tr>
        </thead>
        <tbody id="tbody-fung"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);

const TBODYS = {
  herb: $('#tbody-herb'),
  insec: $('#tbody-insec'),
  fung: $('#tbody-fung'),
};

function esc(s){ return String(s ?? '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
function fmt2(n){ n = Number(n)||0; return n.toFixed(2); }

function parseSKU(sku=''){
  const parts = String(sku).split('-');
  if (parts.length <= 1) return { producto: sku, presentacion: '' };
  return { producto: parts[0], presentacion: parts.slice(1).join('-') };
}

function rowTpl(p, rate){
  const { producto, presentacion } = parseSKU(p?.sku || '');
  const usd = Number(p?.precio_usd || 0);
  const bs  = Number(p?.precio_bs  || (usd*rate));
  return `
    <tr>
      <td>${esc(producto)}</td>
      <td>${esc(presentacion)}</td>
      <td>${esc(p?.unidad || '')}</td>
      <td class="right">${fmt2(usd)}</td>
      <td class="right">${fmt2(bs)}</td>
    </tr>`;
}

function render(prices, rate){
  const groups = { herb: [], insec: [], fung: [] };
  const norm = s => String(s||'').toLowerCase();

  for (const p of prices){
    const c = norm(p.categoria);
    if (c === 'insecticida') groups.insec.push(p);
    else if (c === 'fungicida') groups.fung.push(p);
    else groups.herb.push(p);
  }

  const empty = `<tr><td class="center empty" colspan="5">Sin productos</td></tr>`;
  TBODYS.herb.innerHTML  = groups.herb.length  ? groups.herb.map(x=>rowTpl(x,rate)).join('')  : empty;
  TBODYS.insec.innerHTML = groups.insec.length ? groups.insec.map(x=>rowTpl(x,rate)).join('') : empty;
  TBODYS.fung.innerHTML  = groups.fung.length  ? groups.fung.map(x=>rowTpl(x,rate)).join('')  : empty;
}

(async function init(){
  try{
    const res = await fetch('/api/prices', { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const { prices=[], rate=0, version='' } = await res.json();

    $('#price-meta').textContent = `Versión ${version} • TC ${fmt2(rate)}`;
    render(prices, rate);
  }catch(e){
    console.error(e);
    $('#price-meta').textContent = 'Error cargando precios';
    TBODYS.herb.innerHTML = TBODYS.insec.innerHTML = TBODYS.fung.innerHTML =
      `<tr><td class="center empty" colspan="5">No se pudo cargar</td></tr>`;
  }
})();
</script>
</body>
</html>
